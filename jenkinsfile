pipeline {
    agent any
    parameters {
        booleanParam(name: 'rebuild', defaultValue: False, description: 'Select this option to reconstruct the docker image')
    }
    environment {
        PCLOUD_CREDENTIALS = credentials('bec67a8c-149f-4db9-b4b8-66d61a1e3b02')
    }
    stages {
        stage ('env prep') {
            steps {
                sh 'echo PCLOUD_USER=${PCLOUD_CREDENTIALS_USR} > .env'
                sh 'echo PCLOUD_PASS=${PCLOUD_CREDENTIALS_PSW} >> .env'
            }
        }
        stage('Deleting old docker image') {
            when {
                environment name: 'rebuild',
                value: 'true'
            }
            steps {
                sh 'docker image rm cerberus-cerberus'
            }
        }
        stage('build') {
            steps {
                sh 'docker compose up -d'
            }
        }
        stage ('test'){
            steps {
                sh 'docker exec -t cerberus python -m unittest discover tests'
            }
        }
        stage('execute') {
            steps {
                sh 'docker exec -t cerberus python src/main.py /home/bruno/documents'
            }
        }
    }
    post {
        always {
            sh 'docker compose down'
            echo 'Bye bye!!!'
        }
    }
}