pipeline {
    agent any
    environment {
        PROJECT = 'cerberus'
        PCLOUD_CREDENTIALS = credentials('bec67a8c-149f-4db9-b4b8-66d61a1e3b02')
    }
    stages {
        stage ('env prep') {
            sh 'echo  PCLOUD_USER=${PCLOUD_CREDENTIALS_USR} > .env'
            sh 'echo  PCLOUD_PASS=${PCLOUD_CREDENTIALS_PSW} > .env'
        }
        stage('build') {
            steps {
                sh 'docker compose up -d'
            }
        }
        stage ('test'){
            steps {
                sh 'docker exec -t ${PROJECT} python -m unittest discover tests'
                /*
                sh 'docker exec -t ${PROJECT} python tests/storage_test.py'
                sh 'docker exec -t ${PROJECT} python tests/archiver_test.py'
                sh '''docker exec -t ${PROJECT} python tests/pcloudclient_test.py \
                    -u ${CREDENTIALS_USR} \
                    -p ${CREDENTIALS_PSW} \
                '''
                */
            }
        }
        /*
        stage('execute') {
            steps {
                sh '''docker exec -t cerberus python src/main.py \
                    -d /home/bruno/documents \
                    -u ${CREDENTIALS_USR} \
                    -p ${CREDENTIALS_PSW} \
                '''
            }
        }
        */
    }
    post {
        always {
            sh 'docker compose down'
            echo 'Bye bye!!!'
        }
    }
}